import bcrypt from "bcryptjs"; import User from "@/models/User"; import { signToken } from "@/lib/auth"; export async function registerAdmin(data: { name: string; email: string; password: string; secretKey: string; }) { if (data.secretKey !== process.env.ADMIN_SECRET_KEY) { throw new Error("Invalid admin secret key"); } const exists = await User.findOne({ email: data.email }); if (exists) throw new Error("Admin already registered"); const passwordHash = await bcrypt.hash(data.password, 10); const user = await User.create({ name: data.name, email: data.email, passwordHash, role: "ADMIN", }); const token = signToken({ userId: user._id.toString(), role: "ADMIN" }); return { user, token }; } export async function loginUser(data: { identifier: string; password: string; }) { const user = await User.findOne({ $or: [{ email: data.identifier }, { username: data.identifier }], }); if (!user) throw new Error("Invalid credentials"); const ok = await bcrypt.compare(data.password, user.passwordHash); if (!ok) throw new Error("Invalid credentials"); const token = signToken({ userId: user._id.toString(), role: user.role }); return { user, token }; }